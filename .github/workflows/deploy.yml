name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”‘ Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ğŸš€ Deploy to server
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} 'sudo bash /opt/deploy_az_sunshine.sh'

      - name: âœ… Deployment successful
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.GMAIL_USERNAME }}
          password: ${{ secrets.GMAIL_APP_PASSWORD }}
          subject: "âœ… Deployment Successful - Az Sunshine"
          to: ${{ secrets.EMAIL_TO }}
          from: Az Sunshine Deploy <${{ secrets.GMAIL_USERNAME }}>
          body: |
            ğŸ‰ Deployment to production completed successfully!
            
            ğŸ“¦ Repository: ${{ github.repository }}
            ğŸŒ¿ Branch: ${{ github.ref_name }}
            ğŸ”— Commit: ${{ github.sha }}
            ğŸ’¬ Commit Message: ${{ github.event.head_commit.message }}
            ğŸ‘¤ Author: ${{ github.actor }}
            
            ğŸ–¥ï¸  Server: ${{ secrets.SSH_HOST }}
            â° Time: ${{ github.event.head_commit.timestamp }}
            
            Your application is now live! ğŸš€

      - name: âŒ Deployment failed
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.GMAIL_USERNAME }}
          password: ${{ secrets.GMAIL_APP_PASSWORD }}
          subject: "âŒ URGENT: Deployment Failed - Az Sunshine"
          to: ${{ secrets.EMAIL_TO }}
          from: Az Sunshine Deploy <${{ secrets.GMAIL_USERNAME }}>
          body: |
            âš ï¸ DEPLOYMENT FAILED! âš ï¸
            
            The deployment to production has failed and requires immediate attention.
            
            ğŸ“¦ Repository: ${{ github.repository }}
            ğŸŒ¿ Branch: ${{ github.ref_name }}
            ğŸ”— Commit: ${{ github.sha }}
            ğŸ’¬ Commit Message: ${{ github.event.head_commit.message }}
            ğŸ‘¤ Author: ${{ github.actor }}
            
            ğŸ–¥ï¸  Server: ${{ secrets.SSH_HOST }}
            
            ğŸ“‹ View detailed logs here:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            Please investigate and fix the issue as soon as possible.